<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARIMA API Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .loading { color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ARIMA Forecasting API Connection Test</h1>
        <p>This page tests the connection to the ARIMA forecasting API and displays available data.</p>
        
        <div class="test-section info">
            <h3>API Status</h3>
            <p>API Base URL: <code>http://127.0.0.1:5000</code></p>
            <button onclick="testApiHealth()">Test API Health</button>
            <div id="health-status"></div>
        </div>

        <div class="test-section">
            <h3>Available Crime Types</h3>
            <button onclick="fetchCrimeTypes()">Fetch Crime Types</button>
            <div id="crime-types-result"></div>
        </div>

        <div class="test-section">
            <h3>Available Locations</h3>
            <button onclick="fetchLocations()">Fetch Locations</button>
            <div id="locations-result"></div>
        </div>

        <div class="test-section">
            <h3>Test Forecast</h3>
            <p>Select crime type and location to test forecasting:</p>
            <select id="crimeTypeSelect">
                <option value="">Select Crime Type</option>
            </select>
            <select id="locationSelect">
                <option value="">Select Location</option>
            </select>
            <button onclick="testForecast()">Test Forecast</button>
            <div id="forecast-result"></div>
        </div>

        <div class="test-section">
            <h3>Test Visualization Data</h3>
            <button onclick="testVisualization()">Test Visualization Data</button>
            <div id="visualization-result"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:5000';

        async function testApiHealth() {
            const statusDiv = document.getElementById('health-status');
            statusDiv.innerHTML = '<div class="loading">Testing API health...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/locations`);
                if (response.ok) {
                    statusDiv.innerHTML = '<div class="success">✅ API is running and accessible!</div>';
                } else {
                    statusDiv.innerHTML = '<div class="error">❌ API responded with error: ' + response.status + '</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="error">❌ Cannot connect to API: ' + error.message + '</div>';
            }
        }

        async function fetchCrimeTypes() {
            const resultDiv = document.getElementById('crime-types-result');
            resultDiv.innerHTML = '<div class="loading">Fetching crime types...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/crime_types`);
                const data = await response.json();
                
                if (response.ok) {
                    const crimeTypes = data.crime_types || [];
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>✅ Found ${crimeTypes.length} crime types:</h4>
                            <ul>
                                ${crimeTypes.map(type => `<li>${type}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    
                    // Populate dropdown
                    const select = document.getElementById('crimeTypeSelect');
                    select.innerHTML = '<option value="">Select Crime Type</option>' +
                        crimeTypes.map(type => `<option value="${type}">${type}</option>`).join('');
                } else {
                    resultDiv.innerHTML = '<div class="error">❌ Error: ' + data.error + '</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">❌ Error: ' + error.message + '</div>';
            }
        }

        async function fetchLocations() {
            const resultDiv = document.getElementById('locations-result');
            resultDiv.innerHTML = '<div class="loading">Fetching locations...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/locations`);
                const data = await response.json();
                
                if (response.ok) {
                    const locations = data.locations || [];
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>✅ Found ${locations.length} locations:</h4>
                            <ul>
                                ${locations.map(location => `<li>${location}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    
                    // Populate dropdown
                    const select = document.getElementById('locationSelect');
                    select.innerHTML = '<option value="">Select Location</option>' +
                        locations.map(location => `<option value="${location}">${location}</option>`).join('');
                } else {
                    resultDiv.innerHTML = '<div class="error">❌ Error: ' + data.error + '</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">❌ Error: ' + error.message + '</div>';
            }
        }

        async function testForecast() {
            const crimeType = document.getElementById('crimeTypeSelect').value;
            const location = document.getElementById('locationSelect').value;
            const resultDiv = document.getElementById('forecast-result');
            
            if (!crimeType || !location) {
                resultDiv.innerHTML = '<div class="error">❌ Please select both crime type and location</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">Generating forecast...</div>';
            
            try {
                const params = new URLSearchParams({
                    crime_type: crimeType,
                    location: location,
                    months: '12'
                });
                
                const response = await fetch(`${API_BASE_URL}/api/forecast?${params}`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>✅ Forecast generated successfully!</h4>
                            <p><strong>Crime Type:</strong> ${data.crime_type}</p>
                            <p><strong>Location:</strong> ${data.location}</p>
                            <p><strong>Forecast Period:</strong> ${data.forecast.dates.length} months</p>
                            <p><strong>Sample Values:</strong> ${data.forecast.values.slice(0, 5).map(v => v.toFixed(1)).join(', ')}...</p>
                            <details>
                                <summary>View Full Forecast Data</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="error">❌ Error: ' + data.error + '</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">❌ Error: ' + error.message + '</div>';
            }
        }

        async function testVisualization() {
            const crimeType = document.getElementById('crimeTypeSelect').value;
            const location = document.getElementById('locationSelect').value;
            const resultDiv = document.getElementById('visualization-result');
            
            if (!crimeType || !location) {
                resultDiv.innerHTML = '<div class="error">❌ Please select both crime type and location first</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">Generating visualization data...</div>';
            
            try {
                const params = new URLSearchParams({
                    crime_type: crimeType,
                    location: location,
                    months: '12'
                });
                
                const response = await fetch(`${API_BASE_URL}/api/visualization?${params}`);
                const data = await response.json();
                
                if (response.ok) {
                    const historicalCount = data.raw_data.history.values.length;
                    const forecastCount = data.raw_data.forecast.values.length;
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>✅ Visualization data generated successfully!</h4>
                            <p><strong>Crime Type:</strong> ${data.crime_type}</p>
                            <p><strong>Location:</strong> ${data.location}</p>
                            <p><strong>Historical Data Points:</strong> ${historicalCount}</p>
                            <p><strong>Forecast Data Points:</strong> ${forecastCount}</p>
                            <p><strong>Chart Type:</strong> ${data.chart_config.type}</p>
                            <details>
                                <summary>View Chart Configuration</summary>
                                <pre>${JSON.stringify(data.chart_config, null, 2)}</pre>
                            </details>
                            <details>
                                <summary>View Raw Data</summary>
                                <pre>${JSON.stringify(data.raw_data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="error">❌ Error: ' + data.error + '</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">❌ Error: ' + error.message + '</div>';
            }
        }

        // Auto-fetch crime types and locations on page load
        window.onload = function() {
            fetchCrimeTypes();
            fetchLocations();
        };
    </script>
</body>
</html>